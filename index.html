<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Hand Tracking WebAR (GLB follow)</title>
  <style>
    body,html { margin:0; padding:0; overflow:hidden; background:#000; }
    #video { position:fixed; inset:0; width:100vw; height:100vh; object-fit:cover; transform:scaleX(-1); }
    canvas { position:fixed; inset:0; }
    .hint { position:fixed; left:8px; bottom:8px; color:#fff; font:14px/1.6 system-ui; background:rgba(0,0,0,.35); padding:6px 10px; border-radius:8px; }
  </style>
</head>
<body>
  <video id="video" playsinline muted></video>
  <div class="hint">親指と人差し指を近づけると GLB が手元に出ます</div>

  <!-- Three.js -->
  <script src="https://unpkg.com/three@0.160.0/build/three.min.js"></script>
  <!-- GLTFLoader（非モジュール版 / THREE.GLTFLoader を提供） -->
  <script src="https://unpkg.com/three@0.160.0/examples/js/loaders/GLTFLoader.js"></script>

  <!-- MediaPipe Hands -->
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>

  <script>
  (async () => {
    // === 1) カメラ ===
    const video = document.getElementById('video');
    const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'user' }, audio: false });
    video.srcObject = stream;
    await video.play();

    // === 2) Three.js ===
    const renderer = new THREE.WebGLRenderer({ antialias:true, alpha:true });
    renderer.setPixelRatio(window.devicePixelRatio);
    renderer.setSize(window.innerWidth, window.innerHeight);
    document.body.appendChild(renderer.domElement);

    const scene = new THREE.Scene();
    const camera = new THREE.PerspectiveCamera(60, window.innerWidth/window.innerHeight, 0.01, 100);
    camera.position.set(0,0,1.5);

    const dir = new THREE.DirectionalLight(0xffffff, 1);
    dir.position.set(0,1,1);
    scene.add(dir);
    scene.add(new THREE.AmbientLight(0xffffff, .6));

    window.addEventListener('resize', () => {
      camera.aspect = window.innerWidth/window.innerHeight;
      camera.updateProjectionMatrix();
      renderer.setSize(window.innerWidth, window.innerHeight);
    });

    // === 3) GLB読み込み（sphereの代わり） ===
    const MODEL_URL = encodeURI('無題.glb'); // 同じフォルダに置く
    const loader = new THREE.GLTFLoader();
    let model = new THREE.Group(); // プレースホルダ
    scene.add(model);
    model.visible = false;

    loader.load(
      MODEL_URL,
      (gltf) => {
        // 既存プレースホルダを中身と入替
        model.add(gltf.scene);

        // モデルの中央を原点に合わせ、だいたいのスケールに
        const box = new THREE.Box3().setFromObject(model);
        const size = new THREE.Vector3(); box.getSize(size);
        const center = new THREE.Vector3(); box.getCenter(center);
        model.position.sub(center); // 中心合わせ（以後、positionは手元の座標が上書き）

        // “手サイズ” 目安で調整（必要に応じて値を変えてください）
        const maxDim = Math.max(size.x, size.y, size.z) || 1;
        const targetDim = 0.15; // 15cmくらい
        const s = targetDim / maxDim;
        model.scale.setScalar(s);

        model.visible = false; // 検出されるまで非表示
        console.log('GLB loaded');
      },
      undefined,
      (err) => console.error('GLB load error:', err)
    );

    // === 4) MediaPipe Hands ===
    const hands = new Hands({
      locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`
    });
    hands.setOptions({
      maxNumHands: 1,
      modelComplexity: 1,
      selfieMode: true,
      minTrackingConfidence: 0.6,
      minDetectionConfidence: 0.6
    });

    const Z = 0.6; // カメラ前方の仮想距離（m相当）
    let pinchActive = false;

    hands.onResults((results) => {
      const lm = results.multiHandLandmarks?.[0];
      if (!lm || !model) { model.visible = false; return; }

      const thumbTip = lm[4];
      const indexTip = lm[8];
      // ピンチ距離
      const pinchDist = Math.hypot(thumbTip.x - indexTip.x, thumbTip.y - indexTip.y);
      pinchActive = pinchDist < 0.05;

      // 親指先と人差し指先の中点（画像座標 0..1）
      const u = (thumbTip.x + indexTip.x) * 0.5;
      const v = (thumbTip.y + indexTip.y) * 0.5;

      // 画像座標 → NDC → カメラからZm先の位置へ射影
      const ndcX = ((1 - u) * 2 - 1);    // 鏡面なので(1-u)
      const ndcY = (((1 - v) * 2 - 1) * -1);
      const vec = new THREE.Vector3(ndcX, ndcY, -1).unproject(camera);
      const ray = vec.sub(camera.position).normalize();
      const pos = camera.position.clone().add(ray.multiplyScalar(Z));

      model.position.copy(pos);
      model.visible = true;

      // ピンチ中は少しスケールUP（つかんだ演出）
      const baseScale = model.scale.x;
      const target = pinchActive ? 1.15 : 1.0;
      model.scale.setScalar(baseScale * target); // ※好みで変えてOK
    });

    const mpCamera = new Camera(video, {
      onFrame: async () => { await hands.send({ image: video }); },
      width: 640, height: 480
    });
    mpCamera.start();

    // === 5) ループ ===
    (function loop(){
      renderer.render(scene, camera);
      requestAnimationFrame(loop);
    })();
  })();
  </script>
</body>
</html>
